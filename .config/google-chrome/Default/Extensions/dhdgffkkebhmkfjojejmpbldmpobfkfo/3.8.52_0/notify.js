Registry.require(["prepare","icon"],function(){var t=Registry.get("icon"),r=$.Deferred,h=!1,s=function(){var b={},e=null,c=0;return{init:function(){var d=function(a){e=a||"unknown";h&&console.log("notify: chronos level",a)},c;try{c=chrome.notifications&&chrome.notifications.getPermissionLevel&&chrome.notifications.onPermissionLevelChanged&&chrome.notifications.onClicked}catch(m){}c?(chrome.notifications.getPermissionLevel(d),chrome.notifications.onPermissionLevelChanged.addListener(d),chrome.notifications.onClicked.addListener(function(a){h&&
console.log("notify: chronos click",a);b[a]&&(b[a].cb.click&&b[a].cb.click(),b[a].cancel(),delete b[a])}),chrome.notifications.onClosed.addListener(function(a){h&&console.log("notify: chronos close",a);b[a]&&b[a].cb.close&&b[a].cb.close()})):d("unsupported")},create:function(d,f,m){var a=r(),n=10,l=function(){if(e)if("granted"==e){var g={nid:null,cb:{},on:function(a,k){g.cb[a]=k},cancel:function(){},show:function(){var e={type:"basic",title:f||"",message:m||""};e.iconUrl=0==c?d:"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
chrome.notifications.create("",e,function(k){chrome.runtime&&chrome.runtime.lastError?1>c?(h&&console.log("notify: chronos creating failed, retry...",chrome.runtime.lastError),c++,g.show()):(h&&console.log("notify: chronos creating finally failed",chrome.runtime.lastError),a.reject()):(h&&console.log("notify: chronos created",k),g.cancel=function(){chrome.notifications.clear(k,function(){})},b[k]=g)})}};a.resolve(g)}else a.resolve();else{var q=function(){e?l():n--?window.setTimeout(q,200):a.resolve()};
q()}};l();return a.promise()}}}(),p={notify:function(b,e,c,d,f){var m=!1;f||(m=!0,f=function(){});var a=null,n=!1,l=null,g,q=function(){l&&window.clearTimeout(l);n||f({})},p=function(){n=!0;var k={clicked:n};f&&f(k);a&&a.cancel()};c=c||chrome.extension.getURL("images/icon128.png");t.getDataUriFromUrl(c).then(function(a){g=a;a=r();a.resolve(void 0);return a.promise()}).then(function(){return s.create(g,b,e)}).then(function(a){var c=r();if(!a)try{var d=null.createNotification(g,b||"",e||"");a={on:function(a,
b){d["on"+a]=b},cancel:function(){d.cancel()},show:function(){d.show()}}}catch(f){console.warn("notify: Notification creation failed with: "+f.message),a={cb:{},on:function(b,c){a.cb[b]=c},cancel:function(){},show:function(){m||window.setTimeout(function(){confirm((b?b+"\n\n":"")+e)?a.cb.click&&a.cb.click():a.cb.close&&a.cb.close()},1)}}}c.resolve(a);return c.promise()}).then(function(f){a=f;a.on("close",q);a.on("click",p);l=window.setTimeout(function(){l=null;a.cancel()},d?d:6E5);h&&console.debug("notify:",
b,e,c,d);a.show()})},showUpdate:function(b,e,c,d){p.notify(b,e,c,3E5,d)},show:function(b,e,c,d,f){p.notify(b,e,c,d,f)},debug:function(b){h=b}};Registry.register("notify","52",function(){s.init();return p})});
