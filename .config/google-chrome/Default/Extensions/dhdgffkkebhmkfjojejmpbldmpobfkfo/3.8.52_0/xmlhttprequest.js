Registry.require("helper",function(){var q=Registry.get("helper"),m={},t=function(b){var c=q.isLocalImage(b);return b&&4<b.length&&"http"==b.substr(0,4)||c},u={"user-agent":!0,referer:!0,origin:!0,host:!0,"proxy-connection":!0,"accept-encoding":!0,"accept-charset":!0},p=function(b,c,g){void 0===c&&(c={});void 0===g&&(g={});if(void 0!=window.chrome&&void 0!=window.chrome.xmlHttpRequest)window.chrome.xmlHttpRequest(b,c,g);else{var n=function(a,b){if(c[a])c[a]("function"==typeof b?b():b)},e=function(a,
b){c[a]&&(n(a,b),c[a]=null)},k=!(c.onload||c.onreadychange||c.onprogress||c.onerror||c.ondone||c.ontimeout),d=new XMLHttpRequest,h=function(){var a="",c=b.url;if(2<d.readyState&&(a=d.getAllResponseHeaders(),4==d.readyState)){a&&(a=a.replace(/TM-finalURL\: .*[\r\n]{1,2}/,""));var r=d.getResponseHeader("TM-finalURL");r&&(c=r)}a={readyState:d.readyState,responseHeaders:a,finalUrl:c,status:4==d.readyState?d.status:0,statusText:4==d.readyState?d.statusText:""};4==d.readyState?(d.responseType?(a.responseXML=
null,a.responseText=null):(a.responseXML=d.responseXML?escape(d.responseXML):null,a.responseText=d.responseText),a.response=d.response):(a.responseXML=null,a.responseText="",a.response=null);return a},l=function(){var a=h();4==a.readyState&&200!=a.status&&0!=a.status&&0<b.retries?(b.retries--,p(b,c,g)):(e("onload",a),4==a.readyState&&e("ondone",a))},v=function(){var a=h();4==a.readyState&&200!=a.status&&0!=a.status&&0<b.retries?(b.retries--,p(b,c,g)):(e("onerror",a),e("ondone",a))},s=function(a,b,
c){void 0===c&&(c={});try{var e=null,f=null;if(a.lengthComputable||0<a.totalSize)e=a.position||a.loaded,f=a.totalSize||a.total;else{var g=Number(q.getStringBetweenTags(b.responseHeaders.toLowerCase(),"content-length:","\n").trim()),h=d.responseText?d.responseText.length:0;0==g&&(g=-1);e=a.position||a.loaded||h;f=a.totalSize||a.total||g}c.lengthComputable=a.lengthComputable;c.loaded=e;c.done=e;c.total=f;c.totalSize=f}catch(k){}return c},w=function(a){n("onreadychange",function(){var b=h();b.progress=
s(a,b);return b})},x=function(a){n("onprogress",function(){var b=h();return s(a,b,b)})},y=function(a){a=h();e("ontimeout");e("ondone",a)};k||(d.onload=l,d.onerror=v,d.ontimeout=y,d.onprogress=x,d.onreadystatechange=w);try{if(!g.internal&&!t(b.url))throw Error("Invalid scheme of url: "+b.url);d.open(b.method,b.url,!k,b.user,b.password);if(b.headers)for(var f in b.headers)l=f,m.use&&u[f.toLowerCase()]&&(l=m.prefix+f),d.setRequestHeader(l,b.headers[f]);"undefined"!==typeof b.overrideMimeType&&d.overrideMimeType(b.overrideMimeType);
"undefined"!==typeof b.responseType&&(d.responseType=b.responseType);"undefined"!==typeof b.timeout&&(d.timeout=b.timeout);"undefined"!==typeof b.data?d.send(b.data):d.send()}catch(z){if(console.error(z.stack),f={responseXML:"",responseText:"",response:null,readyState:4,responseHeaders:"",status:403,statusText:"Forbidden"},e("onerror",f),e("ondone",f),k)return f}if(k)return h()}};Registry.register("xmlhttprequest","52",{run:p,setWebRequest:function(b){m=b}})});
